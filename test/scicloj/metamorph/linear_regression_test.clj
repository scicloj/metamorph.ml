(ns scicloj.metamorph.linear-regression-test
  (:require
   [scicloj.metamorph.ml :as ml]
   [scicloj.metamorph.ml.toydata :as data]
   [tech.v3.dataset :as ds]
   [tech.v3.dataset.modelling :as ds-mod]))

(def ds
  (->
   (data/mtcars-ds)
   (ds/drop-columns [:model])
   (ds-mod/set-inference-target :mpg)))

(def model (ml/train ds {:model-type :metamorph.ml/ols}))

(ml/glance model)
;; => _unnamed [1 3]:
;;    |       :totss | :adj.r.squared |         :rss |
;;    |-------------:|---------------:|-------------:|
;;    | 1126.0471875 |     0.80664232 | 147.49443002 |
(ml/tidy model)
;; => _unnamed [11 3]:
;;    | :term |   :estimate |  :std.error |
;;    |-------|------------:|------------:|
;;    |  :mpg | 12.30337416 | 18.71788443 |
;;    |  :cyl | -0.11144048 |  1.04502336 |
;;    | :disp |  0.01333524 |  0.01785750 |
;;    |   :hp | -0.02148212 |  0.02176858 |
;;    | :drat |  0.78711097 |  1.63537307 |
;;    |   :wt | -3.71530393 |  1.89441430 |
;;    | :qsec |  0.82104075 |  0.73084480 |
;;    |   :vs |  0.31776281 |  2.10450861 |
;;    |   :am |  2.52022689 |  2.05665055 |
;;    | :gear |  0.65541302 |  1.49325996 |
;;    | :carb | -0.19941925 |  0.82875250 |


(ml/augment model ds)
;; => _unnamed [32 12]:
;;    | :mpg | :cyl | :disp | :hp | :drat |   :wt | :qsec | :vs | :am | :gear | :carb | :.residuals |
;;    |-----:|-----:|------:|----:|------:|------:|------:|----:|----:|------:|------:|------------:|
;;    | 21.0 |    6 | 160.0 | 110 |  3.90 | 2.620 | 16.46 |   0 |   1 |     4 |     4 | -1.59950576 |
;;    | 21.0 |    6 | 160.0 | 110 |  3.90 | 2.875 | 17.02 |   0 |   1 |     4 |     4 | -1.11188608 |
;;    | 22.8 |    4 | 108.0 |  93 |  3.85 | 2.320 | 18.61 |   1 |   1 |     4 |     1 | -3.45064408 |
;;    | 21.4 |    6 | 258.0 | 110 |  3.08 | 3.215 | 19.44 |   1 |   0 |     3 |     1 |  0.16259545 |
;;    | 18.7 |    8 | 360.0 | 175 |  3.15 | 3.440 | 17.02 |   0 |   0 |     3 |     2 |  1.00656597 |
;;    | 18.1 |    6 | 225.0 | 105 |  2.76 | 3.460 | 20.22 |   1 |   0 |     3 |     1 | -2.28303904 |
;;    | 14.3 |    8 | 360.0 | 245 |  3.21 | 3.570 | 15.84 |   0 |   0 |     3 |     4 | -0.08625625 |
;;    | 24.4 |    4 | 146.7 |  62 |  3.69 | 3.190 | 20.00 |   1 |   0 |     4 |     2 |  1.90398812 |
;;    | 22.8 |    4 | 140.8 |  95 |  3.92 | 3.150 | 22.90 |   1 |   0 |     4 |     2 | -1.61908990 |
;;    | 19.2 |    6 | 167.6 | 123 |  3.92 | 3.440 | 18.30 |   1 |   0 |     4 |     4 |  0.50097006 |
;;    |  ... |  ... |   ... | ... |   ... |   ... |   ... | ... | ... |   ... |   ... |         ... |
;;    | 15.5 |    8 | 318.0 | 150 |  2.76 | 3.520 | 16.87 |   0 |   0 |     3 |     2 | -1.44305322 |
;;    | 15.2 |    8 | 304.0 | 150 |  3.15 | 3.435 | 17.30 |   0 |   0 |     3 |     2 | -2.53218150 |
;;    | 13.3 |    8 | 350.0 | 245 |  3.73 | 3.840 | 15.41 |   0 |   0 |     3 |     4 | -0.00602198 |
;;    | 19.2 |    8 | 400.0 | 175 |  3.08 | 3.845 | 17.05 |   0 |   0 |     3 |     2 |  2.50832101 |
;;    | 27.3 |    4 |  79.0 |  66 |  4.08 | 1.935 | 18.90 |   1 |   1 |     4 |     1 | -0.99346869 |
;;    | 26.0 |    4 | 120.3 |  91 |  4.43 | 2.140 | 16.70 |   0 |   1 |     5 |     2 | -0.15295396 |
;;    | 30.4 |    4 |  95.1 | 113 |  3.77 | 1.513 | 16.90 |   1 |   1 |     5 |     2 |  2.76372742 |
;;    | 15.8 |    8 | 351.0 | 264 |  4.22 | 3.170 | 14.50 |   0 |   1 |     5 |     4 | -3.07004080 |
;;    | 19.7 |    6 | 145.0 | 175 |  3.62 | 2.770 | 15.50 |   0 |   1 |     5 |     6 |  0.00617185 |
;;    | 15.0 |    8 | 301.0 | 335 |  3.54 | 3.570 | 14.60 |   0 |   1 |     5 |     8 |  1.05888162 |
;;    | 21.4 |    4 | 121.0 | 109 |  4.11 | 2.780 | 18.60 |   1 |   1 |     4 |     2 | -2.96826768 |
